name: Deploy Mensal02

on:
  push:
    branches: [ "dev" ]

jobs:
  deploy:
    name: Deploy nas VMs
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Clonar repositório
      uses: actions/checkout@v3

    - name: 🗝️ Configurar acesso SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: 🛡️ Adicionar FRONT_HOST ao known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.FRONT_HOST }} >> ~/.ssh/known_hosts

    - name: 📤 Copiar código para a VM FRONTEND
      run: |
        echo "🔄 Enviando projeto completo para a FRONT (10.0.0.3)..."
        rsync -avz ./ ${{ secrets.FRONT_USER }}@${{ secrets.FRONT_HOST }}:/home/${{ secrets.FRONT_USER }}/mensal02/

    - name: 🚀 Executar deploy completo a partir da FRONT
      run: |
        ssh ${{ secrets.FRONT_USER }}@${{ secrets.FRONT_HOST }} << 'EOF'
          echo "📦 FRONTEND: Build e container"
          cd /home/leonardo_r_calegario/mensal02/frontend
          sudo docker build -t mensal-frontend .
          sudo docker stop mensal-frontend || true && sudo docker rm mensal-frontend || true
          sudo docker run -d --name mensal-frontend -p 3000:3000 mensal-frontend

          echo "📁 Enviando backend para VM BACK (10.0.0.4)"
          scp -r /home/leonardo_r_calegario/mensal02/backend leonardo_r_calegario@10.0.0.4:/home/leonardo_r_calegario/mensal02/

          echo "📁 Enviando banco para VM DB (10.0.0.5)"
          scp -r /home/leonardo_r_calegario/mensal02/banco leonardo_r_calegario@10.0.0.5:/home/leonardo_r_calegario/mensal02/

          echo "🛠️ BACKEND: Build e execução via SSH"
          ssh leonardo_r_calegario@10.0.0.4 '
            cd /home/leonardo_r_calegario/mensal02/backend
            sudo docker build -t mensal-backend .
            sudo docker stop back-container || true && sudo docker rm back-container || true
            sudo docker run -d --name back-container -p 8080:8080 mensal-backend
          '

          echo "🛢️ DB: Subindo docker-compose via SSH"
          ssh leonardo_r_calegario@10.0.0.5 '
            cd /home/leonardo_r_calegario/mensal02/banco
            sudo docker-compose down
            sudo docker-compose up -d
          '
        EOF
